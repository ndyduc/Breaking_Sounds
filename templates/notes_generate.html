<!DOCTYPE html>
{% if 'user_id' not in session %}
{% include 'support/header.html' %}
{% else %}
{% include 'support/sidebar.html' %}
{% endif %}
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Notes Generate</title>
	<link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">
	<script src="https://unpkg.com/magic-snowflakes/dist/snowflakes.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
	<link rel="stylesheet" href="/static/css/notes_genarate.css">
	<link rel="icon" href="/static/logo/music_note_white.png">

</head>
<body>
<div id="gene">
	<div id="gene_body">
		<img src="../static/logo/upload.svg" alt="">
		<div id="inform">Drag or Drop file in here</div>
		<label>(required mp3, wav )</label>
		<label>Or</label>
		<input type="file" name="file" id="file" hidden accept=".mp3, .wav">
		<label for="file" class="custom-file-upload">Browse file</label>
	</div>
	<div id="load">
		{% include 'support/rgbload.html' %}
	</div>
	<div id="file_info" style="display: none; ">
		<img id="file_image" src="" alt="Album Art" width="300px" height="300px" style="border-radius: 10px;">
		<form action="{{ url_for('sounds.result_sheet') }}" method="post" id="info" enctype="multipart/form-data">
			<img id="cancel" src="../static/logo/X.svg" alt="Waveform">
			<input type="file" name="file_up" id="file_up" hidden>
			<input type="text" name="modelname" id="modelname" value="CNN" hidden="">
			<input type="hidden" id="hidden_file_name" name="hidden_file_name">
			<p><strong>File Name:</strong> <label id="file_name"></label></p>
			<div style="display: flex; justify-content: space-between; margin: 10px 0;">
				<p><strong>File Type:</strong> <label id="file_type"></label></p>
				<p><strong>File Size:</strong> <label id="file_size"></label></p>
				<p><strong>Duration:</strong> <label id="file_duration">Loading...</label></p>
			</div>
			<div style="display: flex; justify-content: center;align-items: center;">
				<img id="waveform" src="data:image/png;base64," alt=""
				     style="width: 500px; height: 150px; border-radius: 10px">
			</div>
			<audio id="audio_player" controls></audio>
			<div id="nut_bam">
				<button type="submit" name="action" id="generate_notes" value="generate">Generate Note</button>
				<button type="button" id="isolate">Isolate vocal</button>
			</div>
			<div id="download" style="display: none;">
				<button type="button" id="save_vocal">Save Vocal</button>
				<button type="button" id="dl_vocal">Download File Vocal</button>
			</div>
		</form>
	</div>
	<div id="message">
		<p id="mess"></p>
		<img id="cancel_message" src="../static/logo/X_pink.svg" alt=""
		     style="width: 25px;height: 25px; top: 10px; right: 15px">
	</div>
</div>

<script>
	document.getElementById('cancel_message').addEventListener("click", function () {
		document.getElementById('message').style.display = 'none';
	})
	
	document.getElementById("save_vocal").addEventListener("click", function () {
		document.getElementById('load').style.display = 'flex';
		fetch("/check_session_user_id")
			.then(response => response.json())
			.then(data => {
				if (data.logged_in) {
					let audioPlayer = document.getElementById("audio_player")
					fetch(audioPlayer.src)
						.then(response => response.blob())
						.then(blob => {
							let formData = new FormData();
							let name = document.getElementById("file_name").textContent;
							const imgElement = document.getElementById("file_image");
							const blob2 = dataURLToBlob(imgElement.src);
							
							formData.append("audio", blob, name);
							formData.append("image", blob2, "album_art.jpg");
							
							return fetch("/save_vocals", {
								method: "POST",
								body: formData
							});
						})
						.then(response => response.json())
						.then(result => {
							document.getElementById('load').style.display = 'none';
							let statusElement = document.getElementById("mess");
							let divmess = document.getElementById("message");
							divmess.style.display = "flex";
							
							if (result.status) {
								statusElement.innerText = "File saved at vocals library !";
							} else {
								statusElement.innerText = result.message;
							}
							
							setTimeout(() => {
								divmess.style.display = "none";
							}, 15000);
						})
						.catch(error => console.error("Error:", error));
				} else {
					window.location.href = "{{ url_for('loginbase') }}";
				}
			})
			.catch(error => console.error("Error:", error));
	});
	
	function dataURLToBlob(dataURL) {
		const parts = dataURL.split(",");
		const mime = parts[0].match(/:(.*?);/)[1];
		const binary = atob(parts[1]);
		let len = binary.length;
		let u8arr = new Uint8Array(len);
		
		while (len--) {
			u8arr[len] = binary.charCodeAt(len);
		}
		
		return new Blob([u8arr], {type: mime});
	}
</script>
<script>
	document.getElementById("generate_notes").addEventListener("click", function () {
		document.getElementById("load").style.display = "flex";
	})
	
	document.getElementById("isolate").addEventListener("click", function () {
		document.getElementById("nut_bam").style.display = "none";
		document.getElementById('load').style.display = 'flex';
		uploadFile("isolate");
	});
	
	function uploadFile(action) {
		let fileInput = document.getElementById("file_up");
		let formData = new FormData();
		formData.append("file_up", fileInput.files[0]);
		formData.append("action", action);
		
		fetch("{{ url_for('sounds.upload_file') }}", {
			method: "POST",
			body: formData
		})
			.then(response => response.json())
			.then(data => {
				document.getElementById("file_type").innerText = data.file_type;
				document.getElementById("file_size").innerText = formatFileSize(data.file_size);
				document.getElementById("file_duration").innerText = data.duration || "Unknown";
				document.getElementById("waveform").src = data.waveform;
				
				let audioPlayer = document.getElementById("audio_player");
				audioPlayer.src = data.file;
				if (!audioPlayer.paused) {
					audioPlayer.pause()
					audioPlayer.currentTime = 0;
				}
				document.getElementById("download").style.display = "flex";
				document.getElementById('load').style.display = 'none';
			})
			.catch(error => {
				console.error("Lỗi:", error);
			});
	}
	
	function formatFileSize(bytes) {
		if (bytes < 1024) return bytes + " B";
		if (bytes < 1048576) return (bytes / 1024).toFixed(2) + " KB";
		return (bytes / 1048576).toFixed(2) + " MB";
	}
</script>
<script>
	document.getElementById("dl_vocal").addEventListener("click", function () {
		let audioSrc = document.getElementById("audio_player").src;
		if (!audioSrc) {
			console.error("Không tìm thấy file để tải.");
			return;
		}
		
		let link = document.createElement("a");
		link.href = audioSrc;
		link.download = document.getElementById("file_name").textContent + "_vocals.mp3";
		document.body.appendChild(link);
		link.click();
		document.body.removeChild(link);
	});
	
	document.getElementById("cancel").addEventListener("click", function () {
		let audioPlayer = document.getElementById("audio_player");
		if (!audioPlayer.paused) {
			audioPlayer.pause();
		}
		document.getElementById("gene_body").style.display = "flex";
		document.getElementById("download").style.display = "none";
		document.getElementById("nut_bam").style.display = "flex";
		document.getElementById("file_info").style.display = "none";
	});
	
	document.addEventListener("DOMContentLoaded", function () {
		let dropArea = document.getElementById("gene_body");
		let fileInput = document.getElementById("file");
		
		["dragenter", "dragover", "dragleave", "drop"].forEach(event => {
			dropArea.addEventListener(event, e => e.preventDefault());
		});
		
		dropArea.addEventListener("dragenter", () => dropArea.classList.add("highlight"));
		dropArea.addEventListener("dragleave", () => dropArea.classList.remove("highlight"));
		
		dropArea.addEventListener("drop", function (e) {
			dropArea.classList.remove("highlight");
			if (e.dataTransfer.files.length > 0) {
				processFile(e.dataTransfer.files[0]);
			}
		});
		
		// Xử lý khi chọn file từ input
		fileInput.addEventListener("change", function () {
			if (this.files.length > 0) {
				processFile(this.files[0]);
			}
		});
	});
	
	function isValidFileType(file) {
		const allowedTypes = ["audio/mp3", "audio/wav", "audio/x-wav", "audio/mpeg"];
		return allowedTypes.includes(file.type);
	}
	
	function processFile(file) {
		if (!isValidFileType(file)) {
			alert("Please choose file MP3 or WAV !");
			document.getElementById("file").value = ""; // Reset input
			return;
		}
		
		let dataTransfer = new DataTransfer();
		dataTransfer.items.add(file);
		
		// Gán file vào input ẩn
		let hiddenFileInput = document.getElementById("file_up");
		hiddenFileInput.files = dataTransfer.files;
		
		// Cập nhật thông tin file
		updateFileInfo(file);
		
		// Hiển thị audio player
		let fileURL = URL.createObjectURL(file);
		document.getElementById("audio_player").src = fileURL;
		
		getAudioDuration(fileURL);
		extractFileThumbnail(file);
		
		document.getElementById("gene_body").style.display = "none";
		document.getElementById("file_info").style.display = "flex";
		
		let formData = new FormData();
		formData.append("file", file);
		
		fetch("{{ url_for('sounds.get_waveform') }}", {
			method: "POST",
			body: formData
		})
			.then(response => response.blob())
			.then(blob => {
				document.getElementById("waveform").src = URL.createObjectURL(blob);
			})
			.catch(error => console.error("Lỗi:", error));
	}
	
	function updateFileInfo(file) {
		document.getElementById("file_name").textContent = file.name;
		document.getElementById("file_type").textContent = file.type;
		document.getElementById("file_size").textContent = (file.size / 1024 / 1024).toFixed(2) + " MB";
		document.getElementById("hidden_file_name").value = file.name;
	}
	
	function getAudioDuration(fileURL) {
		let audio = new Audio(fileURL);
		audio.addEventListener("loadedmetadata", function () {
			document.getElementById("file_duration").textContent = formatTime(audio.duration);
		});
	}
	
	function formatTime(seconds) {
		let h = Math.floor(seconds / 3600);
		let m = Math.floor((seconds % 3600) / 60);
		let s = Math.floor(seconds % 60);
		return (h > 0 ? h.toString().padStart(2, "0") + ":" : "") +
			m.toString().padStart(2, "0") + ":" +
			s.toString().padStart(2, "0");
	}
	
	function extractFileThumbnail(file) {
		jsmediatags.read(file, {
			onSuccess: function (tag) {
				if (tag.tags.picture) {
					let {data, format} = tag.tags.picture;
					let base64String = data.reduce((acc, byte) => acc + String.fromCharCode(byte), "");
					document.getElementById("file_image").src = `data:${format};base64,${btoa(base64String)}`;
				} else {
					document.getElementById("file_image").src = "default-thumbnail.png";
				}
			},
			onError: function () {
				document.getElementById("file_image").src = "default-thumbnail.png";
			}
		});
	}
	
	document.addEventListener("keydown", function (event) {
		let audioPlayer = document.getElementById("audio_player");
		
		if (!audioPlayer.src) return; // Nếu chưa có file, bỏ qua
		
		switch (event.key) {
			case "ArrowLeft": // Tua lùi 15s
				audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 15);
				break;
			case "ArrowRight": // Tua tới 15s
				audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 15);
				break;
			case " ": // Phát / Dừng khi nhấn Space
				event.preventDefault(); // Ngăn trang web cuộn khi nhấn Space
				if (audioPlayer.paused) {
					audioPlayer.play();
				} else {
					audioPlayer.pause();
				}
				break;
			case "m": // Tắt / Bật âm thanh khi nhấn "m"
				audioPlayer.muted = !audioPlayer.muted;
				break;
			case "ArrowUp": // Tăng âm lượng
				audioPlayer.volume = Math.min(1, audioPlayer.volume + 0.1);
				break;
			case "ArrowDown": // Giảm âm lượng
				audioPlayer.volume = Math.max(0, audioPlayer.volume - 0.1);
				break;
		}
	});
	
	document.getElementById("isolate").addEventListener("click", function () {
		let Size = parseFloat(document.getElementById("file_size").textContent.replace("MB", "").trim());
		let duration = document.getElementById("file_duration").textContent; // Lấy duration dưới dạng hh:mm:ss
		
		function durationToSeconds(duration) {
			let parts = duration.split(":").map(Number);
			if (parts.length === 3) {
				return parts[0] * 3600 + parts[1] * 60 + parts[2];
			} else if (parts.length === 2) {
				return parts[0] * 60 + parts[1];
			}
			return 0;
		}
		
		let durationInSeconds = durationToSeconds(duration);
		
		if (Size > 30) {
			alert("The limit of size is 30MB.");
			return;
		}
		
		if (durationInSeconds > 3600) {
			alert("File is too long, the maximum acceptable is 1 hour.");
		}
	});
</script>
<script>new Snowflakes();</script>
</body>
</html>